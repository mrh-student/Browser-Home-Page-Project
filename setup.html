<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Set Up</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="node_modules/requirejs/require.js"></script>
    <script type="text/javascript" src="config.json"></script>
    <style>
        body {
            background-color: aquamarine;
            font-family: 'Lato', sans-serif;
        }

        header, main {
            margin: auto;
            width: 50%;
        }

        section {
            margin: 10px 10px;
            color: rgb(0, 0, 0);
            background-color: rgba(255,255,255,0.38);
            width: 100%;
            overflow-x: hidden;
            border-radius: 25px;
            padding: 10px;
        }

        article {
            margin: 10px 10px;
        }

        span {
            margin: 5px;
        }

        div {
            margin: 5px;
        }
    </style>
</head>
<body onload="read_config();">
    <header>
        <h1>Home Page Configuration</h1>
    </header>
    <main>
        <section>
            <span><h3>Current configuration:</h3></span>  
            <div id="read"></div>
        </section>
        <section>
            <span><h3>Update configuration:</h3></span><br>
            <table>
                <tr>
                    <td><span>Your name:</span></td>
                    <td><input type="text" value="" id="user_name"></td>
                </tr>
                <tr>
                    <td><span>Your location (used for weather):</span></td>
                    <td><input type="text" value="" id="user_location"></td>
                </tr>
                <tr>
                    <td><span>Your <a href="https://openweathermap.org/appid#get" target=_blank>openweathermap API key</a></span></td>
                    <td><input type="text" value="" id="APIkey"></td>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="button" value="Go" onclick="dosomething();"/></td>
                </tr>
            </table>
            <p>Note: You can also open config.json and make the changes in the file directly. 
                Updating the configuration here will download a new file you can use to replace the old configuration.</p>
        </section>
        <section>
            <div id="greeting"></div>
            <div id="weather"></div>
            <div id="check"></div>
            <article>
                <div id="next"></div>
            </article>
        </section>
    </main>

    <script>
        function dosomething(){
            var name = document.getElementById('user_name').value;
            var location = document.getElementById('user_location').value;
            var APIkey = document.getElementById('APIkey').value;
            console.log(name + location);
            give_greeting(name);
            document.getElementById("check").innerHTML= "<span>Does that look correct to you?</span><br><br><input type='button' id='save' value='Yes, save.' onclick='save_config();'/>";

            var url = "http://api.openweathermap.org/data/2.5/weather?q="+location+"&appid="+APIkey;
            $.getJSON(url, function(data){
                var temp_k = data.main.temp;
                var temp = Math.round(temp_k - 273.15);
                var condition = data.weather[0].description;
                console.log(temp+" "+condition);
                give_temp(temp, condition, location);
            });
        }
        function give_temp(temp, condition, location){
            document.getElementById("weather").innerHTML = "It's " + temp + "Â°C in " + location + " with " + condition ;
            console.log(temp, condition)
        }

        function give_greeting(name){
            document.getElementById("greeting").innerHTML = "Hello, "+ name ;
            console.log(name)
        }

        function read_config(){
            var config_data = JSON.parse(user);
            var user_name = config_data[0].user_name;
            var location = config_data[0].weather_location;
            var openweatherAPI = config_data[0].openweatherAPI;
            console.log(user_name+  location)
            document.getElementById("read").innerHTML = "User name: "+user_name+" <br> Location for weather: "+location+"<br> openweathermap API key: "+ openweatherAPI;
        }

        function save_config(){
            var config_data = JSON.parse(user);
            var new_name = document.getElementById('user_name').value;
            var new_location = document.getElementById('user_location').value;
            var new_APIkey = document.getElementById('APIkey').value;
            config_data[0].user_name = new_name;
            config_data[0].weather_location = new_location;
            config_data[0].openweatherAPI = new_APIkey;
            var new_config_data = "user ='"+JSON.stringify(config_data)+"'";
            console.log(new_config_data);
            function download(content, fileName, contentType) {
                var a = document.createElement("a");
                var file = new Blob([content], {type: contentType});
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
            }
            download(new_config_data, 'config.json', 'application/json');

            document.getElementById("next").innerHTML = "Make sure the downloaded file is named 'config.json' and place it in the same folder as index.html<br>Overwrite any older files if they exist.<br><br><input type='button' value='Done! Take me to my home page' onclick='take_me_home();' />"
        }

        function take_me_home() {
            window.open ('index.html','_self',false);
        }

    </script>
    </body>
</html>